version: '3.7'

services:
  ingress:
    image: haproxy:2.3
    restart: on-failure
    ports:
      - 127.0.0.1:443:443
    volumes:
      - type: bind
        source: ./ingress/conf
        target: /usr/local/etc/haproxy
        read_only: true
    networks:
      internet:
        ipv4_address: 172.10.0.2


  dic-fhir-proxy:
    image: ghcr.io/highmed/fhir_proxy:0.5.0-RC1
    restart: on-failure
    secrets:
      - proxy_dic_certificate_and_int_cas.pem
      - proxy_dic_certificate_private_key.pem
      - proxy_trusted_client_cas.pem
    environment:
      TZ: Europe/Berlin
      HTTPS_SERVER_NAME_PORT: dic:443
      APP_SERVER_IP: dic-fhir-app
      SSL_CERTIFICATE_FILE: /run/secrets/proxy_dic_certificate_and_int_cas.pem
      SSL_CERTIFICATE_KEY_FILE: /run/secrets/proxy_dic_certificate_private_key.pem
      SSL_CA_CERTIFICATE_FILE: /run/secrets/proxy_trusted_client_cas.pem
    networks:
      internet:
        ipv4_address: 172.10.0.3
        aliases:
          - dic
      dic-fhir-frontend:
    depends_on:
      - ingress
      - dic-fhir-app
  dic-fhir-app:
    image: ghcr.io/highmed/fhir:0.5.0-RC1
    restart: on-failure
    secrets:
      - db_liquibase.password
      - db_fhir_user.password
      - db_fhir_user_permanent_delete.password
      - app_client_trust_certificates.pem
      - app_dic_client_certificate.pem
      - app_dic_client_certificate_private_key.pem
      - app_client_certificate_private_key.pem.password
    volumes:
      - type: bind
        source: ./dic/fhir/conf/bundle.xml
        target: /opt/fhir/conf/bundle.xml
      - type: bind
        source: ./dic/fhir/log
        target: /opt/fhir/log
    environment:
      TZ: Europe/Berlin
      ORG_HIGHMED_DSF_FHIR_DB_LIQUIBASE_PASSWORD_FILE: /run/secrets/db_liquibase.password
      ORG_HIGHMED_DSF_FHIR_DB_USER_PASSWORD_FILE: /run/secrets/db_fhir_user.password
      ORG_HIGHMED_DSF_FHIR_DB_USER_PERMANENT_DELETE_PASSWORD_FILE: /run/secrets/db_fhir_user_permanent_delete.password
      ORG_HIGHMED_DSF_FHIR_CLIENT_TRUST_CERTIFICATES: /run/secrets/app_client_trust_certificates.pem
      ORG_HIGHMED_DSF_FHIR_CLIENT_CERTIFICATE: /run/secrets/app_dic_client_certificate.pem
      ORG_HIGHMED_DSF_FHIR_CLIENT_CERTIFICATE_PRIVATE_KEY: /run/secrets/app_dic_client_certificate_private_key.pem
      ORG_HIGHMED_DSF_FHIR_CLIENT_CERTIFICATE_PRIVATE_KEY_PASSWORD_FILE: /run/secrets/app_client_certificate_private_key.pem.password
      ORG_HIGHMED_DSF_FHIR_DB_URL: jdbc:postgresql://dic-fhir-db/fhir
      ORG_HIGHMED_DSF_FHIR_SERVER_BASE_URL: https://dic/fhir
      ORG_HIGHMED_DSF_FHIR_SERVER_ORGANIZATION_IDENTIFIER_VALUE: Test_DIC
      ORG_HIGHMED_DSF_FHIR_SERVER_USER_THUMBPRINTS: ${DIC_USER_THUMBPRINTS}
      ORG_HIGHMED_DSF_FHIR_SERVER_USER_THUMBPRINTS_PERMANENT_DELETE: ${DIC_USER_THUMBPRINTS_PERMANENT_DELETE}
    networks:
      dic-fhir-frontend:
      dic-fhir-backend:
      internet:
          ipv4_address: 172.10.0.53
    depends_on:
      - dic-fhir-db
  dic-fhir-db:
    image: postgres:13
    restart: on-failure
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U liquibase_user -d fhir" ]
      interval: 10s
      timeout: 5s
      retries: 5
    environment:
      TZ: Europe/Berlin
      POSTGRES_PASSWORD_FILE: /run/secrets/db_liquibase.password
      POSTGRES_USER: liquibase_user
      POSTGRES_DB: fhir
    networks:
      - dic-fhir-backend
    secrets:
      - db_liquibase.password

  # dic-bpe-proxy not needed
  dic-bpe-app:
    image: ghcr.io/highmed/bpe:0.5.0-RC1
    restart: on-failure
    ports:
      - 127.0.0.1:5003:5003
    secrets:
      - db_liquibase.password
      - db_bpe_user.password
      - db_bpe_user_camunda.password
      - app_client_trust_certificates.pem
      - app_dic_client_certificate.pem
      - app_dic_client_certificate_private_key.pem
      - app_client_certificate_private_key.pem.password
      - codex_crr_public_key.pem
    volumes:
      - type: bind
        source: ./dic/bpe/plugin
        target: /opt/bpe/plugin
        read_only: true
      - type: bind
        source: ./dic/bpe/process
        target: /opt/bpe/process
        read_only: true
      - type: bind
        source: ./dic/bpe/log
        target: /opt/bpe/log
      - type: bind
        source: ./dic/bpe/last_event
        target: /opt/bpe/last_event
    environment:
      TZ: Europe/Berlin
      EXTRA_JVM_ARGS: -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5003
      ORG_HIGHMED_DSF_BPE_DB_LIQUIBASE_PASSWORD_FILE: /run/secrets/db_liquibase.password
      ORG_HIGHMED_DSF_BPE_DB_USER_PASSWORD_FILE: /run/secrets/db_bpe_user.password
      ORG_HIGHMED_DSF_BPE_DB_USER_CAMUNDA_PASSWORD_FILE: /run/secrets/db_bpe_user_camunda.password
      ORG_HIGHMED_DSF_BPE_FHIR_CLIENT_TRUST_CERTIFICATES: /run/secrets/app_client_trust_certificates.pem
      ORG_HIGHMED_DSF_BPE_FHIR_CLIENT_CERTIFICATE: /run/secrets/app_dic_client_certificate.pem
      ORG_HIGHMED_DSF_BPE_FHIR_CLIENT_CERTIFICATE_PRIVATE_KEY: /run/secrets/app_dic_client_certificate_private_key.pem
      ORG_HIGHMED_DSF_BPE_FHIR_CLIENT_CERTIFICATE_PRIVATE_KEY_PASSWORD_FILE: /run/secrets/app_client_certificate_private_key.pem.password
      ORG_HIGHMED_DSF_BPE_DB_URL: jdbc:postgresql://dic-bpe-db/bpe
      ORG_HIGHMED_DSF_BPE_FHIR_SERVER_ORGANIZATION_IDENTIFIER_VALUE: Test_DIC
      ORG_HIGHMED_DSF_BPE_FHIR_SERVER_BASE_URL: https://dic/fhir
      ORG_HIGHMED_DSF_BPE_PROCESS_EXCLUDED: wwwnetzwerk-universitaetsmedizinde_dataTranslate/0.5.0,wwwnetzwerk-universitaetsmedizinde_dataReceive/0.5.0
      DE_NETZWERK-UNIVERSITAETSMEDIZIN_CODEX_GTH_IDENTIFIER_VALUE: Test_GTH
      DE_NETZWERK-UNIVERSITAETSMEDIZIN_CODEX_CRR_PUBLIC_KEY: /run/secrets/codex_crr_public_key.pem
      DE_NETZWERK-UNIVERSITAETSMEDIZIN_CODEX_FHIR_SERVER_BASE: http://dic-fhir-store:8080/fhir
    networks:
      dic-bpe-frontend:
      dic-bpe-backend:
      internet:
        ipv4_address: 172.10.0.103
    depends_on:
      - dic-bpe-db
      - dic-fhir-proxy
    # - dic-fhir-store not defining a dependency here, dic-fhir-store* needs to be started manually
  dic-bpe-db:
    image: postgres:13
    restart: on-failure
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U liquibase_user -d bpe" ]
      interval: 10s
      timeout: 5s
      retries: 5
    environment:
      TZ: Europe/Berlin
      POSTGRES_PASSWORD_FILE: /run/secrets/db_liquibase.password
      POSTGRES_USER: liquibase_user
      POSTGRES_DB: bpe
    networks:
      - dic-bpe-backend
    secrets:
      - db_liquibase.password
  dic-fhir-store-hapi:
    build: ./dic/hapi
    restart: on-failure
    ports:
      - 127.0.0.1:8080:8080
    environment:
      TZ: Europe/Berlin
    networks:
      dic-bpe-backend:
        aliases:
          - dic-fhir-store
  dic-fhir-store-blaze:
    image: ghcr.io/num-codex/blaze
    ports:
      - 127.0.0.1:8080:8080
    environment:
      TZ: Europe/Berlin
    networks:
      dic-bpe-backend:
        aliases:
          - dic-fhir-store


  gth-fhir-proxy:
    image: ghcr.io/highmed/fhir_proxy:0.5.0-RC1
    restart: on-failure
    secrets:
      - proxy_gth_certificate_and_int_cas.pem
      - proxy_gth_certificate_private_key.pem
      - proxy_trusted_client_cas.pem
    environment:
      TZ: Europe/Berlin
      HTTPS_SERVER_NAME_PORT: gth:443
      APP_SERVER_IP: gth-fhir-app
      SSL_CERTIFICATE_FILE: /run/secrets/proxy_gth_certificate_and_int_cas.pem
      SSL_CERTIFICATE_KEY_FILE: /run/secrets/proxy_gth_certificate_private_key.pem
      SSL_CA_CERTIFICATE_FILE: /run/secrets/proxy_trusted_client_cas.pem
    networks:
      internet:
        ipv4_address: 172.10.0.4
        aliases:
          - gth
      gth-fhir-frontend:
    depends_on:
      - ingress
      - gth-fhir-app
  gth-fhir-app:
    image: ghcr.io/highmed/fhir:0.5.0-RC1
    restart: on-failure
    secrets:
      - db_liquibase.password
      - db_fhir_user.password
      - db_fhir_user_permanent_delete.password
      - app_client_trust_certificates.pem
      - app_gth_client_certificate.pem
      - app_gth_client_certificate_private_key.pem
      - app_client_certificate_private_key.pem.password
    volumes:
      - type: bind
        source: ./gth/fhir/conf/bundle.xml
        target: /opt/fhir/conf/bundle.xml
      - type: bind
        source: ./gth/fhir/log
        target: /opt/fhir/log
    environment:
      TZ: Europe/Berlin
      ORG_HIGHMED_DSF_FHIR_DB_LIQUIBASE_PASSWORD_FILE: /run/secrets/db_liquibase.password
      ORG_HIGHMED_DSF_FHIR_DB_USER_PASSWORD_FILE: /run/secrets/db_fhir_user.password
      ORG_HIGHMED_DSF_FHIR_DB_USER_PERMANENT_DELETE_PASSWORD_FILE: /run/secrets/db_fhir_user_permanent_delete.password
      ORG_HIGHMED_DSF_FHIR_CLIENT_TRUST_CERTIFICATES: /run/secrets/app_client_trust_certificates.pem
      ORG_HIGHMED_DSF_FHIR_CLIENT_CERTIFICATE: /run/secrets/app_gth_client_certificate.pem
      ORG_HIGHMED_DSF_FHIR_CLIENT_CERTIFICATE_PRIVATE_KEY: /run/secrets/app_gth_client_certificate_private_key.pem
      ORG_HIGHMED_DSF_FHIR_CLIENT_CERTIFICATE_PRIVATE_KEY_PASSWORD_FILE: /run/secrets/app_client_certificate_private_key.pem.password
      ORG_HIGHMED_DSF_FHIR_DB_URL: jdbc:postgresql://gth-fhir-db/fhir
      ORG_HIGHMED_DSF_FHIR_SERVER_BASE_URL: https://gth/fhir
      ORG_HIGHMED_DSF_FHIR_SERVER_ORGANIZATION_IDENTIFIER_VALUE: Test_GTH
      ORG_HIGHMED_DSF_FHIR_SERVER_USER_THUMBPRINTS: ${GTH_USER_THUMBPRINTS}
      ORG_HIGHMED_DSF_FHIR_SERVER_USER_THUMBPRINTS_PERMANENT_DELETE: ${GTH_USER_THUMBPRINTS_PERMANENT_DELETE}
    networks:
      gth-fhir-frontend:
      gth-fhir-backend:
      internet:
        ipv4_address: 172.10.0.54
    depends_on:
      - gth-fhir-db
  gth-fhir-db:
    image: postgres:13
    restart: on-failure
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U liquibase_user -d fhir" ]
      interval: 10s
      timeout: 5s
      retries: 5
    environment:
      TZ: Europe/Berlin
      POSTGRES_PASSWORD_FILE: /run/secrets/db_liquibase.password
      POSTGRES_USER: liquibase_user
      POSTGRES_DB: fhir
    networks:
      - gth-fhir-backend
    secrets:
      - db_liquibase.password

  # gth-bpe-proxy not needed
  gth-bpe-app:
    image: ghcr.io/highmed/bpe:0.5.0-RC1
    restart: on-failure
    ports:
      - 127.0.0.1:5004:5004
    secrets:
      - db_liquibase.password
      - db_bpe_user.password
      - db_bpe_user_camunda.password
      - app_client_trust_certificates.pem
      - app_gth_client_certificate.pem
      - app_gth_client_certificate_private_key.pem
      - app_client_certificate_private_key.pem.password
    volumes:
      - type: bind
        source: ./gth/bpe/plugin
        target: /opt/bpe/plugin
        read_only: true
      - type: bind
        source: ./gth/bpe/process
        target: /opt/bpe/process
        read_only: true
      - type: bind
        source: ./gth/bpe/log
        target: /opt/bpe/log
      - type: bind
        source: ./gth/bpe/last_event
        target: /opt/bpe/last_event
    environment:
      TZ: Europe/Berlin
      EXTRA_JVM_ARGS: -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5004
      ORG_HIGHMED_DSF_BPE_DB_LIQUIBASE_PASSWORD_FILE: /run/secrets/db_liquibase.password
      ORG_HIGHMED_DSF_BPE_DB_USER_PASSWORD_FILE: /run/secrets/db_bpe_user.password
      ORG_HIGHMED_DSF_BPE_DB_USER_CAMUNDA_PASSWORD_FILE: /run/secrets/db_bpe_user_camunda.password
      ORG_HIGHMED_DSF_BPE_FHIR_CLIENT_TRUST_CERTIFICATES: /run/secrets/app_client_trust_certificates.pem
      ORG_HIGHMED_DSF_BPE_FHIR_CLIENT_CERTIFICATE: /run/secrets/app_gth_client_certificate.pem
      ORG_HIGHMED_DSF_BPE_FHIR_CLIENT_CERTIFICATE_PRIVATE_KEY: /run/secrets/app_gth_client_certificate_private_key.pem
      ORG_HIGHMED_DSF_BPE_FHIR_CLIENT_CERTIFICATE_PRIVATE_KEY_PASSWORD_FILE: /run/secrets/app_client_certificate_private_key.pem.password
      ORG_HIGHMED_DSF_BPE_DB_URL: jdbc:postgresql://gth-bpe-db/bpe
      ORG_HIGHMED_DSF_BPE_FHIR_SERVER_ORGANIZATION_IDENTIFIER_VALUE: Test_GTH
      ORG_HIGHMED_DSF_BPE_FHIR_SERVER_BASE_URL: https://gth/fhir
      ORG_HIGHMED_DSF_BPE_PROCESS_EXCLUDED: wwwnetzwerk-universitaetsmedizinde_dataTrigger/0.5.0,,wwwnetzwerk-universitaetsmedizinde_dataSend/0.5.0,wwwnetzwerk-universitaetsmedizinde_dataReceive/0.5.0
      DE_NETZWERK-UNIVERSITAETSMEDIZIN_CODEX_GTH_IDENTIFIER_VALUE: Test_GTH
      DE_NETZWERK-UNIVERSITAETSMEDIZIN_CODEX_CRR_IDENTIFIER_VALUE: Test_CRR
    networks:
      gth-bpe-frontend:
      gth-bpe-backend:
      internet:
        ipv4_address: 172.10.0.104
    depends_on:
      - gth-bpe-db
      - gth-fhir-proxy
  gth-bpe-db:
    image: postgres:13
    restart: on-failure
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U liquibase_user -d bpe" ]
      interval: 10s
      timeout: 5s
      retries: 5
    environment:
      TZ: Europe/Berlin
      POSTGRES_PASSWORD_FILE: /run/secrets/db_liquibase.password
      POSTGRES_USER: liquibase_user
      POSTGRES_DB: bpe
    networks:
      - gth-bpe-backend
    secrets:
      - db_liquibase.password


  crr-fhir-proxy:
    image: ghcr.io/highmed/fhir_proxy:0.5.0-RC1
    restart: on-failure
    secrets:
      - proxy_crr_certificate_and_int_cas.pem
      - proxy_crr_certificate_private_key.pem
      - proxy_trusted_client_cas.pem
    environment:
      TZ: Europe/Berlin
      HTTPS_SERVER_NAME_PORT: crr:443
      APP_SERVER_IP: crr-fhir-app
      SSL_CERTIFICATE_FILE: /run/secrets/proxy_crr_certificate_and_int_cas.pem
      SSL_CERTIFICATE_KEY_FILE: /run/secrets/proxy_crr_certificate_private_key.pem
      SSL_CA_CERTIFICATE_FILE: /run/secrets/proxy_trusted_client_cas.pem
    networks:
      internet:
        ipv4_address: 172.10.0.5
        aliases:
          - crr
      crr-fhir-frontend:
    depends_on:
      - ingress
      - crr-fhir-app
  crr-fhir-app:
    image: ghcr.io/highmed/fhir:0.5.0-RC1
    restart: on-failure
    secrets:
      - db_liquibase.password
      - db_fhir_user.password
      - db_fhir_user_permanent_delete.password
      - app_client_trust_certificates.pem
      - app_crr_client_certificate.pem
      - app_crr_client_certificate_private_key.pem
      - app_client_certificate_private_key.pem.password
    volumes:
      - type: bind
        source: ./crr/fhir/conf/bundle.xml
        target: /opt/fhir/conf/bundle.xml
      - type: bind
        source: ./crr/fhir/log
        target: /opt/fhir/log
    environment:
      TZ: Europe/Berlin
      ORG_HIGHMED_DSF_FHIR_DB_LIQUIBASE_PASSWORD_FILE: /run/secrets/db_liquibase.password
      ORG_HIGHMED_DSF_FHIR_DB_USER_PASSWORD_FILE: /run/secrets/db_fhir_user.password
      ORG_HIGHMED_DSF_FHIR_DB_USER_PERMANENT_DELETE_PASSWORD_FILE: /run/secrets/db_fhir_user_permanent_delete.password
      ORG_HIGHMED_DSF_FHIR_CLIENT_TRUST_CERTIFICATES: /run/secrets/app_client_trust_certificates.pem
      ORG_HIGHMED_DSF_FHIR_CLIENT_CERTIFICATE: /run/secrets/app_crr_client_certificate.pem
      ORG_HIGHMED_DSF_FHIR_CLIENT_CERTIFICATE_PRIVATE_KEY: /run/secrets/app_crr_client_certificate_private_key.pem
      ORG_HIGHMED_DSF_FHIR_CLIENT_CERTIFICATE_PRIVATE_KEY_PASSWORD_FILE: /run/secrets/app_client_certificate_private_key.pem.password
      ORG_HIGHMED_DSF_FHIR_DB_URL: jdbc:postgresql://crr-fhir-db/fhir
      ORG_HIGHMED_DSF_FHIR_SERVER_BASE_URL: https://crr/fhir
      ORG_HIGHMED_DSF_FHIR_SERVER_ORGANIZATION_IDENTIFIER_VALUE: Test_CRR
      ORG_HIGHMED_DSF_FHIR_SERVER_USER_THUMBPRINTS: ${CRR_USER_THUMBPRINTS}
      ORG_HIGHMED_DSF_FHIR_SERVER_USER_THUMBPRINTS_PERMANENT_DELETE: ${CRR_USER_THUMBPRINTS_PERMANENT_DELETE}
    networks:
      crr-fhir-frontend:
      crr-fhir-backend:
      internet:
        ipv4_address: 172.10.0.55
    depends_on:
      - crr-fhir-db
  crr-fhir-db:
    image: postgres:13
    restart: on-failure
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U liquibase_user -d fhir" ]
      interval: 10s
      timeout: 5s
      retries: 5
    environment:
      TZ: Europe/Berlin
      POSTGRES_PASSWORD_FILE: /run/secrets/db_liquibase.password
      POSTGRES_USER: liquibase_user
      POSTGRES_DB: fhir
    networks:
      - crr-fhir-backend
    secrets:
      - db_liquibase.password

  # crr-bpe-proxy not needed
  crr-bpe-app:
    image: ghcr.io/highmed/bpe:0.5.0-RC1
    restart: on-failure
    ports:
      - 127.0.0.1:5005:5005
    secrets:
      - db_liquibase.password
      - db_bpe_user.password
      - db_bpe_user_camunda.password
      - app_client_trust_certificates.pem
      - app_crr_client_certificate.pem
      - app_crr_client_certificate_private_key.pem
      - app_client_certificate_private_key.pem.password
      - codex_crr_private_key.pem
    volumes:
      - type: bind
        source: ./crr/bpe/plugin
        target: /opt/bpe/plugin
        read_only: true
      - type: bind
        source: ./crr/bpe/process
        target: /opt/bpe/process
        read_only: true
      - type: bind
        source: ./crr/bpe/log
        target: /opt/bpe/log
      - type: bind
        source: ./crr/bpe/last_event
        target: /opt/bpe/last_event
    environment:
      TZ: Europe/Berlin
      EXTRA_JVM_ARGS: -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005
      ORG_HIGHMED_DSF_BPE_DB_LIQUIBASE_PASSWORD_FILE: /run/secrets/db_liquibase.password
      ORG_HIGHMED_DSF_BPE_DB_USER_PASSWORD_FILE: /run/secrets/db_bpe_user.password
      ORG_HIGHMED_DSF_BPE_DB_USER_CAMUNDA_PASSWORD_FILE: /run/secrets/db_bpe_user_camunda.password
      ORG_HIGHMED_DSF_BPE_FHIR_CLIENT_TRUST_CERTIFICATES: /run/secrets/app_client_trust_certificates.pem
      ORG_HIGHMED_DSF_BPE_FHIR_CLIENT_CERTIFICATE: /run/secrets/app_crr_client_certificate.pem
      ORG_HIGHMED_DSF_BPE_FHIR_CLIENT_CERTIFICATE_PRIVATE_KEY: /run/secrets/app_crr_client_certificate_private_key.pem
      ORG_HIGHMED_DSF_BPE_FHIR_CLIENT_CERTIFICATE_PRIVATE_KEY_PASSWORD_FILE: /run/secrets/app_client_certificate_private_key.pem.password
      ORG_HIGHMED_DSF_BPE_DB_URL: jdbc:postgresql://crr-bpe-db/bpe
      ORG_HIGHMED_DSF_BPE_FHIR_SERVER_ORGANIZATION_IDENTIFIER_VALUE: Test_CRR
      ORG_HIGHMED_DSF_BPE_FHIR_SERVER_BASE_URL: https://crr/fhir
      ORG_HIGHMED_DSF_BPE_PROCESS_EXCLUDED: wwwnetzwerk-universitaetsmedizinde_dataTrigger/0.5.0,,wwwnetzwerk-universitaetsmedizinde_dataSend/0.5.0,wwwnetzwerk-universitaetsmedizinde_dataTranslate/0.5.0
      DE_NETZWERK-UNIVERSITAETSMEDIZIN_CODEX_GTH_IDENTIFIER_VALUE: Test_GTH
      DE_NETZWERK-UNIVERSITAETSMEDIZIN_CODEX_CRR_IDENTIFIER_VALUE: Test_CRR
      DE_NETZWERK-UNIVERSITAETSMEDIZIN_CODEX_CRR_PRIVATE_KEY: /run/secrets/codex_crr_private_key.pem
      DE_NETZWERK-UNIVERSITAETSMEDIZIN_CODEX_FHIR_SERVER_BASE: http://crr-fhir-bridge:8888/fhir-bridge/fhir
    networks:
      crr-bpe-frontend:
      crr-bpe-backend:
      internet:
        ipv4_address: 172.10.0.105
    depends_on:
      - crr-bpe-db
      - crr-fhir-proxy
    # - crr-fhir-bridge not defining a dependency here, crr-fhir-bridge* needs to be started manually
  crr-bpe-db:
    image: postgres:13
    restart: on-failure
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U liquibase_user -d bpe" ]
      interval: 10s
      timeout: 5s
      retries: 5
    environment:
      TZ: Europe/Berlin
      POSTGRES_PASSWORD_FILE: /run/secrets/db_liquibase.password
      POSTGRES_USER: liquibase_user
      POSTGRES_DB: bpe
    networks:
      - crr-bpe-backend
    secrets:
      - db_liquibase.password
  crr-ehrbase-db:
    image: ehrbase/ehrbase-postgres:latest
    networks:
      - crr-ehrbase-network
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      EHRBASE_USER: ehrbase
      EHRBASE_PASSWORD: ehrbase
      TZ: Europe/Berlin
  crr-ehrbase:
    image: ehrbase/ehrbase:next
    networks:
      - crr-ehrbase-network
    environment:
      DB_URL: jdbc:postgresql://crr-ehrbase-db:5432/ehrbase
      DB_USER: ehrbase
      DB_PASS: ehrbase
      SECURITY_AUTHTYPE: BASIC
      SECURITY_AUTHUSER: myuser
      SECURITY_AUTHPASSWORD: myPassword432
      SECURITY_AUTHADMINUSER: myadmin
      SECURITY_AUTHADMINPASSWORD: mySuperAwesomePassword123
      SYSTEM_NAME: local.ehrbase.org
      ADMIN_API_ACTIVE: 'true'
      TZ: Europe/Berlin
    depends_on:
      - crr-ehrbase-db
  crr-fhir-bridge:
    image: ehrbase/fhir-bridge:1.2.1
    ports:
      - 127.0.0.1:8888:8888
      - 127.0.0.1:5006:5006
    networks:
      - crr-ehrbase-network
      - crr-bpe-backend
    environment:
      FHIR_BRIDGE_EHRBASE_BASE_URL: http://crr-ehrbase:8080/ehrbase/rest/openehr/v1/
      FHIR_BRIDGE_FHIR_VALIDATION_OPTIONAL_IDENTIFIER: 'true'
      TZ: Europe/Berlin
#     SPRING_PROFILES_ACTIVE: dev
      JAVA_TOOL_OPTIONS: -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5006
    depends_on:
      - crr-ehrbase


secrets:
  proxy_dic_certificate_and_int_cas.pem:
    file: ./secrets/proxy_dic_certificate_and_int_cas.pem
  proxy_dic_certificate_private_key.pem:
    file: ./secrets/proxy_dic_certificate_private_key.pem

  proxy_gth_certificate_and_int_cas.pem:
    file: ./secrets/proxy_gth_certificate_and_int_cas.pem
  proxy_gth_certificate_private_key.pem:
    file: ./secrets/proxy_gth_certificate_private_key.pem

  proxy_crr_certificate_and_int_cas.pem:
    file: ./secrets/proxy_crr_certificate_and_int_cas.pem
  proxy_crr_certificate_private_key.pem:
    file: ./secrets/proxy_crr_certificate_private_key.pem

  proxy_trusted_client_cas.pem:
    file: ./secrets/proxy_trusted_client_cas.pem

  db_liquibase.password:
    file: ./secrets/db_liquibase.password
  db_fhir_user.password:
    file: ./secrets/db_fhir_user.password
  db_fhir_user_permanent_delete.password:
    file: ./secrets/db_fhir_user_permanent_delete.password
  db_bpe_user.password:
    file: ./secrets/db_bpe_user.password
  db_bpe_user_camunda.password:
    file: ./secrets/db_bpe_user_camunda.password

  app_client_trust_certificates.pem:
    file: ./secrets/app_client_trust_certificates.pem
  app_client_certificate_private_key.pem.password:
    file: ./secrets/app_client_certificate_private_key.pem.password

  app_dic_client_certificate.pem:
    file: ./secrets/app_dic_client_certificate.pem
  app_dic_client_certificate_private_key.pem:
    file: ./secrets/app_dic_client_certificate_private_key.pem

  app_gth_client_certificate.pem:
    file: ./secrets/app_gth_client_certificate.pem
  app_gth_client_certificate_private_key.pem:
    file: ./secrets/app_gth_client_certificate_private_key.pem

  app_crr_client_certificate.pem:
    file: ./secrets/app_crr_client_certificate.pem
  app_crr_client_certificate_private_key.pem:
    file: ./secrets/app_crr_client_certificate_private_key.pem

  codex_crr_public_key.pem:
    file: ./secrets/codex_crr_public_key.pem
  codex_crr_private_key.pem:
    file: ./secrets/codex_crr_private_key.pem

networks:
  internet:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.10.0.0/24

  dic-fhir-frontend:
  dic-fhir-backend:
  dic-bpe-frontend:
  dic-bpe-backend:
  gth-fhir-frontend:
  gth-fhir-backend:
  gth-bpe-frontend:
  gth-bpe-backend:
  crr-fhir-frontend:
  crr-fhir-backend:
  crr-bpe-frontend:
  crr-bpe-backend:
  crr-ehrbase-network:


volumes:
  dic-fhir-db-data:
    name: dic-fhir-db-data
  dic-bpe-db-data:
    name: dic-bpe-db-data
  gth-fhir-db-data:
    name: gth-fhir-db-data
  gth-bpe-db-data:
    name: gth-bpe-db-data
  crr-fhir-db-data:
    name: crr-fhir-db-data
  crr-bpe-db-data:
    name: crr-bpe-db-data
